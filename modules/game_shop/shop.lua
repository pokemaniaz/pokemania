marketOffers = { -- Name/Description/Image/Cost/Promotion
[1] = {'Vip', '30 Days', 'vip', 10, false, 'Vip30'},
[2] = {'Vip', '60 Days', 'vip', 18, false, 'Vip60'},
[3] = {'Vip', '90 Days', 'vip', 25, false, 'Vip90'},
[4] = {'Gender', 'Change Sex', 'changegender', 15, false, 'Sexy'},
[5] = {'Pokemon', 'Ditto', 'ditto', 40, false, 'Ditto'},
[6] = {'Pokemon', 'Shiny Ditto', 'shiny ditto', 80, false, 'ShinyDitto'},
[7] = {'XP Boost', 'XP Boost 20% (1h)', 'xpboost', 5, false, 'Boost20'},
[8] = {'Shiny Charm', 'Shiny Charm (3d)', 'shinycharm', 17, false, 'Charm3'},
[9] = {'Shiny Charm', 'Shiny Charm (7d)', 'shinycharm', 35, false, 'Charm7'},
[10] = {'Shiny Charm', 'Shiny Charm (30d)', 'shinycharm', 65, false, 'Charm30'},
[11] = {'Boss Charm', 'Boss Charm (3d)', 'bosscharm', 25, false, 'Boss3'},
[12] = {'Boss Charm', 'Boss Charm (7d)', 'bosscharm', 55, false, 'Boss7'},
[13] = {'Boss Charm', 'Boss Charm (30d)', 'bosscharm', 85, false, 'Boss30'},
[14] = {'Mega Charm', 'Mega Charm (3d)', 'megacharm', 45, false, 'Mega3'},
[15] = {'Mega Charm', 'Mega Charm (7d)', 'megacharm', 85, false, 'Mega7'},
[16] = {'Mega Charm', 'Mega Charm (30d)', 'megacharm', 100, false, 'Mega30'},
[17] = {'Bike', 'Bike', 'Bike', 10, false, 'Bike'},
[18] = {'Memory', 'Ditto 2�(Slot)', 'MemoryDitto', 15, false, 'Memory'},
[19] = {'Memory', 'Ditto 3�(Slot)', 'MemoryDitto2', 10, false, 'Memory2'},
[20] = {'Memory', 'Shiny Ditto All(Slot)', 'MemoryShiny', 35, false, 'ShinyMemory'},
[21] = {'Pok�Card', 'Snorlax (20)', 'Snorlaxcard', 30, false, 'Snorlax'},
[22] = {'Pok�Card', 'Aerodactyl (20)', 'Aerodactylcard', 30, false, 'Aerodactyl'},
[23] = {'Pok�Card', 'Dragonite (20)', 'Dragonitecard', 30, false, 'Dragonite'},
[24] = {'Pok�Card', 'Mew (50)', 'Mewcard', 80, false, 'Mew'},
[25] = {'Pok�Card', 'Mewtwo (50)', 'Mewtwocard', 100, false, 'Mewtwo'},
--// New's \\ --
[26] = {'Aura', 'Particle Aura', 'Particle', 15, false, 'Particle'},
[27] = {'Radar', 'Radar Brotherhood', 'Radar Brotherhood', 100, false, 'Brotherhood'},
[28] = {'Radar', 'Radar Boss', 'Radar Boss', 100, false, 'Boss'},
[29] = {'Held', 'Held Recovery', 'Recovery', 25, false, 'Recovery'},
[30] = {'XP Boost Clan', 'XP Clan 2x (2h)', 'XP Clan', 25, false, 'Xpclan2'},
[31] = {'XP Boost Clan', 'XP Clan 2x (5h)', 'XP Clan', 40, false, 'Xpclan5'},
[32] = {'Ceifador Locker', 'Locker', 'Locker', 50, false, 'Locker'},
[33] = {'Smeargle', 'Reset (1)', 'Smearglereset', 15, false, 'smeargle1'},
[34] = {'Smeargle', 'Reset All', 'Smeargleall', 25, false, 'smeargleall'},
}

outfitsOffers = { -- Name/Description/Type/Head/Body/Legs/Feet/Cost/Promotion
[1] = {'Slash', 'Male', 1441, 0, 114, 94, 114, 10, false, 'outfitslash'},
[2] = {'PlayBoy', 'Female', 1442, 0, 0, 114, 94, 10, false, 'outfitplayboy'},
[3] = {'Vinganca', 'Male', 1443, 0, 0, 114, 94, 10, false, 'outfitvinganca'},
[4] = {'House', 'Male', 1444, 0, 0, 114, 94, 10, false, 'outfithouse'},
[5] = {'Veteran Trainer', 'Male', 1465, 0, 0, 114, 94, 15, false, 'outfitveteran'},
[6] = {'Veteran Trainer', 'Female', 1466, 0, 0, 114, 94, 15, false, 'outfitveteran'},
[7] = {'Assassin', 'Female', 1469, 0, 0, 114, 94, 15, false, 'outfitassasin'},
[8] = {'Assassin', 'Male', 1470, 0, 0, 114, 94, 15, false, 'outfitassasin'},
[9] = {'Duelist', 'Male', 1671, 0, 0, 114, 94, 10, false, 'outfitduelist'},
[10] = {'Duelist', 'Female', 1672, 0, 0, 114, 94, 10, false, 'outfitduelist'},
[11] = {'Rabbitt', 'Female', 1679, 0, 0, 114, 94, 10, false, 'outfitrabbitt'},
[12] = {'Rabbitt', 'Male', 1680, 0, 0, 114, 94, 10, false, 'outfitrabbitt'},
[13] = {'Iron Man', 'Male', 1675, 0, 0, 114, 94, 20, false, 'outfitiron'},
[14] = {'Fantasia', 'Female', 2711, 0, 0, 114, 94, 20, false, 'outfitfantasia'},
[15] = {'Fantasia', 'Male', 2710, 0, 0, 114, 94, 20, false, 'outfitfantasia'},
[16] = {'Jack', 'Male', 2727, 0, 0, 114, 94, 20, false, 'outfithallowen'},
[17] = {'Noiva Cadaver', 'Female', 2728, 0, 0, 114, 94, 20, false, 'outfithallowen'},
[18] = {'Duende', 'Male', 2742, 0, 0, 114, 94, 20, false, 'outfitnatal'},
[19] = {'Duende', 'Female', 2743, 0, 0, 114, 94, 20, false, 'outfitnatal'},
}

addonsOffers = { -- Name/Description/Type/Head/Body/Legs/Feet/Cost/Promotion
[1] = {'Samurai Armor', 'Shiny Flareon', 2553, 0, 114, 94, 114, 10, false, 'addonfire'},
[2] = {'Christmas Hat', 'Shiny Hypno', 2647, 0, 114, 94, 114, 10, false, 'addonchristmas'},
[3] = {'Joker Custume', 'Shiny Hypno', 2648, 0, 114, 94, 114, 10, false, 'addonjoker'},
[4] = {'Murmilo Helmet', 'Shiny Nidoking', 2558, 0, 114, 94, 114, 10, false, 'addonmurmilo'},
[5] = {'Spikes', 'Shiny Golem', 2557, 0, 0, 94, 114, 10, false, 'addonspikes'},
[6] = {'Christmas Hat', 'Shiny Lucario', 2614, 0, 114, 94, 114, 10, false, 'addonchristmas'},
[7] = {'Christmas Hat', 'Shiny Hitmontop', 2029, 0, 114, 94, 114, 10, false, 'addonchristmas'},
[8] = {'Samurai Armor', 'Shiny Jolteon', 2554, 0, 114, 94, 114, 10, false, 'addonthunder'},
--
[9] = {'Bandit Mask', 'Shiny Electabuzz', 2903, 0, 114, 94, 114, 25, false, 'addonbandit'},
[10] = {'Blue Scouter', 'Shiny Magmar', 2904, 0, 114, 94, 114, 25, false, 'addonscouter'},
[11] = {'Christmas Wood', 'Shiny Sudowoodo', 2905, 0, 114, 94, 114, 25, false, 'addonwood'},
[12] = {'Clan Costume', 'Shiny Typhlosion', 2906, 0, 114, 94, 114, 25, false, 'addonclan'},
[13] = {'Gray Postman Bag', 'Shiny Dragonite', 2907, 0, 114, 94, 114, 25, false, 'addongraypost'},
[14] = {'Green Apron', 'Shiny Mr. Mime', 2908, 0, 114, 94, 114, 25, false, 'addongreenapron'},
[15] = {'Jester Hat', 'Shiny Tangela', 2909, 0, 114, 94, 114, 25, false, 'addonjester'},
[16] = {'Mage Hat', 'Shiny Alakazam', 2910, 0, 114, 94, 114, 25, false, 'addonmage'},
[17] = {'Megazord', 'Shiny Tyranitar', 2911, 0, 114, 94, 114, 25, false, 'addonmegazord'},
[18] = {'Superhero', 'Shiny Scyther', 2912, 0, 114, 94, 114, 25, false, 'addonsuper'},
[19] = {'Oriental Mask', 'Shiny Gyarados', 2913, 0, 114, 94, 114, 25, false, 'addonoriental'},
[20] = {'Reaper Costume', 'Shiny Marowak', 2914, 0, 114, 94, 114, 25, false, 'addonreaper'},
[21] = {'Wizard Hat', 'Shiny Alakazam', 2915, 0, 114, 94, 114, 25, false, 'adonnwizard'},
[22] = {'Wedding Costume', 'Shiny Jynx', 2916, 0, 114, 94, 114, 25, false, 'addonwedding'},
[23] = {'Hat Costume', 'Shiny Alakazam', 2917, 0, 114, 94, 114, 25, false, 'addonhat'},
[24] = {'Predator Mask', 'Shiny Magmar', 2918, 0, 114, 94, 114, 25, false, 'addonpredator'},
[25] = {'Green Dragon Scarf', 'Shiny Dragonite', 2922, 0, 114, 94, 114, 25, false, 'addongreendragon'},
[26] = {'Green Scouter', 'Shiny Magmar', 2924, 0, 114, 94, 114, 25, false, 'addongreenscouter'},
[27] = {'Metal Pack', 'Shiny Electabuzz', 2925, 0, 114, 94, 114, 25, false, 'addonmetal'},
[28] = {'Raiden Hat', 'Shiny Electabuzz', 2927, 0, 114, 94, 114, 25, false, 'addonraidenhat'},
[29] = {'Retro Mask', 'Shiny Gyarados', 2928, 0, 114, 94, 114, 25, false, 'addonretromask'},
[30] = {'Star Costume', 'Shiny Magcargo', 2930, 0, 114, 94, 114, 25, false, 'addonstarcostume'},
}

clansOffers = {
[1] = {'Clan', 'Gardestrike', 'gardestrike', false},
[2] = {'Clan', 'Ironhard', 'ironhard', false},
[3] = {'Clan', 'Malefic', 'malefic', false},
[4] = {'Clan', 'Naturia', 'naturia', false},
[5] = {'Clan', 'Orebound', 'orebound', false},
[6] = {'Clan', 'Psycraft', 'psycraft', false},
[7] = {'Clan', 'Raibolt', 'raibolt', false},
[8] = {'Clan', 'Seavell', 'seavell', false},
[9] = {'Clan', 'Volcanic', 'volcanic', false},
[10] = {'Clan', 'Wingeon', 'wingeon', false},
}

showEvent = nil
hideEvent = nil
clanWindow = nil

function init()
  connect(g_game, { onGameEnd = hide })
  connect(g_game, 'onTextMessage', onConfirmBought)

  shopWindow = g_ui.displayUI('shop', modules.game_interface.getRootPanel())
  shopButton = modules.game_pokemon.getbuttonsWindow():recursiveGetChildById('shopButton')
  playerEmeralds = shopWindow:recursiveGetChildById('emeraldsLabel')
  offerSearch = shopWindow:recursiveGetChildById('searchText')
  shopButton:setOn(false)
  shopWindow:hide()

  shopTabBar = shopWindow:recursiveGetChildById('shopTabBar')
  shopTabBar:setContentWidget(shopWindow:recursiveGetChildById('shopTabContent'))
  shopTabBar.onTabChange = onTabChange

  marketPanel = g_ui.loadUI('market')
  shopTabBar:addTab('', marketPanel, '/images/game/shop/market')

  outfitsPanel = g_ui.loadUI('outfits')
  shopTabBar:addTab('', outfitsPanel, '/images/game/shop/outfits')

  addonsPanel = g_ui.loadUI('addons')
  shopTabBar:addTab('', addonsPanel, '/images/game/shop/addons')

  clansPanel = g_ui.loadUI('clans')
  shopTabBar:addTab('', clansPanel, '/images/game/shop/clans')

  shopTabBar:addButton('', function() g_game.talk('Buy Diamonds') end, '/images/game/shop/buy_emeralds')
end

function terminate()
  disconnect(g_game, { onGameEnd = hide })
  disconnect(g_game, 'onTextMessage', onConfirmBought)

  shopWindow:destroy()
end

function show()
  g_effects.cancelFade(shopWindow)
  removeEvent(hideEvent)
  if not showEvent then
    showEvent = addEvent(function() g_effects.fadeIn(shopWindow, 250) end)
  end
  shopButton:setOn(true)
  shopWindow:raise()
  shopWindow:focus()
  shopWindow:show()
  playerEmeralds:setText(g_game.getLocalPlayer():getItemsCount(3028))
  setOffers(marketPanel)
  setOffers(outfitsPanel)
  setOffers(addonsPanel)
  setOffers(clansPanel)
end

function hide()
  shopButton:setOn(false)
  hideEvent = scheduleEvent(function() shopWindow:hide() end, 250)
  addEvent(function() g_effects.fadeOut(shopWindow, 250) end)
  showEvent = nil
end

function toggle()
  if shopButton:isOn() then
    shopButton:setOn(false)
    hide()
  else
    shopButton:setOn(true)
    show()
  end
end

function onConfirmBought(mode, text)
  if not getCodeBuffer(mode, 163, text) then return end
  local buffer = getCodeBuffer(mode, 163, text)
  if string.find(buffer, 'manyPoints') then
    return displayInfoBox('Emerald Shop', tr('You already have many points.'))
  elseif string.find(buffer, 'clanName') then
    local clan = string.explode(buffer, '|')[2]
    return displayInfoBox('Emerald Shop', tr('You already belong to the clan %s.', doCorrectString(clan)))
  elseif string.find(buffer, 'clanRank') then
    local rank = string.explode(buffer, '|')[2]
    return displayInfoBox('Emerald Shop', tr('You must be at least rank %s.', rank))
  elseif string.find(buffer, 'clanLevel') then
    local level = string.explode(buffer, '|')[2]
    local clan = string.explode(buffer, '|')[3]
    local rank = string.explode(buffer, '|')[4]
    return displayInfoBox('Emerald Shop', tr('You need to be level %s to switch to %s rank %s.', level, doCorrectString(clan), rank))
  end
  local name = string.explode(buffer, '|')[1]
  local description = string.explode(buffer, '|')[2]
  playerEmeralds:setText(g_game.getLocalPlayer():getItemsCount(3028))
  displayInfoBox('Emerald Shop', tr('You bought %s (%s)!', name, description))
end

function onBuyMarket(buyId)
  if g_game.getLocalPlayer():getItemsCount(3028) >= marketOffers[buyId][4] then
    if not confirmWindow then
      local yesCallback = function()		
		g_game.talk('/shop '..marketOffers[buyId][6])
        if confirmWindow then
          confirmWindow:destroy()
          confirmWindow = nil
        end
      end

      local noCallback = function()
        confirmWindow:destroy()
        confirmWindow = nil
      end
      confirmWindow = displayGeneralBox('Emerald Shop', tr('Are you sure you want to buy %s (%s)?', marketOffers[buyId][1], marketOffers[buyId][2]), {
        { text=tr('Yes'), callback=yesCallback },
        { text=tr('No'), callback=noCallback },
      anchor=AnchorHorizontalCenter}, yesCallback, noCallback)
    else
      confirmWindow:destroy()
      confirmWindow = nil
      onBuyMarket(buyId)
    end
  else
    displayInfoBox('Emerald Shop', tr('You don\'t have enough emeralds.'))
  end
end

function onBuyOutfit(buyId)
  if g_game.getLocalPlayer():getItemsCount(3028) >= outfitsOffers[buyId][8] then
    if not confirmWindow then
      local yesCallback = function()		
		g_game.talk('/shop '..outfitsOffers[buyId][10])
        if confirmWindow then
          confirmWindow:destroy()
          confirmWindow = nil
        end
      end

      local noCallback = function()
        confirmWindow:destroy()
        confirmWindow = nil
      end
      confirmWindow = displayGeneralBox('Emerald Shop', tr('Are you sure you want to buy %s (%s)?', outfitsOffers[buyId][1], outfitsOffers[buyId][2]), {
        { text=tr('Yes'), callback=yesCallback },
        { text=tr('No'), callback=noCallback },
      anchor=AnchorHorizontalCenter}, yesCallback, noCallback)
    else
      confirmWindow:destroy()
      confirmWindow = nil
      onBuyOutfit(buyId)
    end
  else
    displayInfoBox('Emerald Shop', tr('You don\'t have enough emeralds.'))
  end
end

function onBuyAddons(buyId)
  if g_game.getLocalPlayer():getItemsCount(3028) >= addonsOffers[buyId][8] then
    if not confirmWindow then
      local yesCallback = function()		
		g_game.talk('/shop '..addonsOffers[buyId][10])
        if confirmWindow then
          confirmWindow:destroy()
          confirmWindow = nil
        end
      end

      local noCallback = function()
        confirmWindow:destroy()
        confirmWindow = nil
      end
      confirmWindow = displayGeneralBox('Emerald Shop', tr('Are you sure you want to buy %s (%s)?', addonsOffers[buyId][1], addonsOffers[buyId][2]), {
        { text=tr('Yes'), callback=yesCallback },
        { text=tr('No'), callback=noCallback },
      anchor=AnchorHorizontalCenter}, yesCallback, noCallback)
    else
      confirmWindow:destroy()
      confirmWindow = nil
      onBuyOutfit(buyId)
    end
  else
    displayInfoBox('Emerald Shop', tr('You don\'t have enough emeralds.'))
  end
end

function onBuyClan(clanId)
  destroyClanWindow()
  clanWindow = g_ui.createWidget('ClanWindow', rootWidget)
  local callback = function()
    local cost = string.explode(clanWindow:getChildById('prize'):getText(), ' Emeralds')[1]
    if g_game.getLocalPlayer():getItemsCount(3028) >= tonumber(cost) then
   --   sendInfoToServer(163, clansOffers[clanId][1]:lower()..'|'..clansOffers[clanId][2]..'|'..cost)
	  g_game.talk('/clan '..clansOffers[clanId][2]..''..cost)
      destroyClanWindow()
    else
      displayInfoBox('Emerald Shop', tr('You don\'t have enough emeralds.'))
    end
  end
  clanWindow:setText(clansOffers[clanId][2])
  clanWindow:getChildById('okButton').onClick = callback
  clanWindow.onEnter = callback
end

function destroyClanWindow()
  if clanWindow then
    clanWindow:destroy()
    clanWindow = nil
  end
end

function onTabChange(tabBar, tab)
  offerSearch:clearText()
end

function searchOffer()
  local panel = shopTabBar:getCurrentTabPanel():getChildByIndex(1)
  local searchFilter = offerSearch:getText():lower()
  for i = 1, panel:getChildCount() do
    local button = panel:getChildByIndex(i)
    local searchCondition = (searchFilter == '') or (searchFilter ~= '' and (string.find(button.name:lower(), searchFilter) ~= nil or string.find(button.description:lower(), searchFilter) ~= nil))
    button:setVisible(searchCondition)
  end
end

function setOffers(panel)
  local offersPanel = panel:getChildByIndex(1)
  if offersPanel:getId() == 'shopMarket' then
    for i = 1, #marketOffers do
      local widget = offersPanel:getChildByIndex(i)
      widget:setId(i)
      widget:getChildByIndex(1):setText(marketOffers[i][1])
      widget:getChildByIndex(2):setText(marketOffers[i][2])
      widget:getChildByIndex(3):setImageSource('/images/game/shop/market/'..marketOffers[i][3])
      widget:getChildByIndex(4):setText(marketOffers[i][4]..' Emeralds')
      widget.name = marketOffers[i][1]
      widget.description = marketOffers[i][2]
      widget.sale = marketOffers[i][5]
      if widget.sale then
        widget:getChildByIndex(1):setColor('#FF2000')
        widget:getChildByIndex(2):setColor('#FF2000')
        widget:getChildByIndex(3):setIconColor('white')
        widget:getChildByIndex(4):setColor('#CC2000')
      else
        widget:getChildByIndex(1):setColor('white')
        widget:getChildByIndex(2):setColor('white')
        widget:getChildByIndex(3):setIconColor('alpha')
        widget:getChildByIndex(4):setColor('white')
      end
    end
  elseif offersPanel:getId() == 'shopOutfits' then
    for i = 1, #outfitsOffers do
      local widget = offersPanel:getChildByIndex(i)
      local player = g_game.getLocalPlayer()
      local outfit = player:getOutfit()
      outfit.type = outfitsOffers[i][3]
      outfit.head = outfitsOffers[i][4]
      outfit.body = outfitsOffers[i][5]
      outfit.legs = outfitsOffers[i][6]
      outfit.feet = outfitsOffers[i][7]
      widget:setId(i)
      widget:getChildByIndex(1):setText(outfitsOffers[i][1])
      widget:getChildByIndex(2):setText(outfitsOffers[i][2])
      widget:getChildByIndex(3):setCreature()
      widget:getChildByIndex(3):setOutfit(outfit)
      widget:getChildByIndex(4):setText(outfitsOffers[i][8]..' Emeralds')
      widget.name = outfitsOffers[i][1]
      widget.description = outfitsOffers[i][2]
      widget.sale = outfitsOffers[i][9]
      if widget.sale then
        widget:getChildByIndex(1):setColor('#FF2000')
        widget:getChildByIndex(2):setColor('#FF2000')
        widget:getChildByIndex(3):getChildByIndex(1):setIconColor('white')
        widget:getChildByIndex(4):setColor('#CC2000')
      else
        widget:getChildByIndex(1):setColor('white')
        widget:getChildByIndex(2):setColor('white')
        widget:getChildByIndex(3):getChildByIndex(1):setIconColor('alpha')
        widget:getChildByIndex(4):setColor('white')
      end
    end
  elseif offersPanel:getId() == 'shopAddons' then
    for i = 1, #addonsOffers do
      local widget = offersPanel:getChildByIndex(i)
      local player = g_game.getLocalPlayer()
      local outfit = player:getOutfit()
      outfit.type = addonsOffers[i][3]
      outfit.head = addonsOffers[i][4]
      outfit.body = addonsOffers[i][5]
      outfit.legs = addonsOffers[i][6]
      outfit.feet = addonsOffers[i][7]
      widget:setId(i)
      widget:getChildByIndex(1):setText(addonsOffers[i][1])
      widget:getChildByIndex(2):setText(addonsOffers[i][2])
      widget:getChildByIndex(3):setCreature()
      widget:getChildByIndex(3):setOutfit(outfit)
      widget:getChildByIndex(4):setText(addonsOffers[i][8]..' Emeralds')
      widget.name = addonsOffers[i][1]
      widget.description = addonsOffers[i][2]
      widget.sale = addonsOffers[i][9]
      if widget.sale then
        widget:getChildByIndex(1):setColor('#FF2000')
        widget:getChildByIndex(2):setColor('#FF2000')
        widget:getChildByIndex(3):getChildByIndex(1):setIconColor('white')
        widget:getChildByIndex(4):setColor('#CC2000')
      else
        widget:getChildByIndex(1):setColor('white')
        widget:getChildByIndex(2):setColor('white')
        widget:getChildByIndex(3):getChildByIndex(1):setIconColor('alpha')
        widget:getChildByIndex(4):setColor('white')
      end
    end
  elseif offersPanel:getId() == 'shopClans' then
    for i = 1, #clansOffers do
      local widget = offersPanel:getChildByIndex(i)
      widget:setId(i)
      widget:setImageSource('/images/game/shop/clans/'..clansOffers[i][3])
      widget.name = clansOffers[i][1]
      widget.description = clansOffers[i][2]
      widget.sale = clansOffers[i][4]
    end
  end
end
